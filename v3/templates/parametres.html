{% extends "base.html" %}

{% block header %}Paramètres{% endblock %}

{% block content %}
<div x-data="settingsApp()" class="min-h-screen">
    <div class="max-w-4xl mx-auto">
        <div class="mb-8 pl-4">
            <h1
                class="text-4xl font-bold text-white mb-2 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-400" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
                    <circle cx="12" cy="12" r="3" />
                </svg>
                Paramètres
            </h1>
            <p class="text-slate-400 text-lg">
                Gérez vos préférences et informations de compte
            </p>
        </div>

        <!-- Success/Error Message -->
        <div x-show="saveMessage" x-transition
            class="mb-6 mx-4 p-4 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
            <span x-text="saveMessage"></span>
        </div>

        <div class="grid md:grid-cols-2 gap-6 px-4">
            <!-- Profile Information -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="font-semibold text-white mb-4">Informations du Profil</h3>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-white text-sm font-medium">Nom Complet</label>
                        <input type="text" x-model="preferences.full_name"
                            class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500"
                            placeholder="Votre nom">
                    </div>

                    <div class="space-y-2">
                        <label class="text-white text-sm font-medium">Email</label>
                        <input type="email" x-model="preferences.email" disabled
                            class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-slate-400 cursor-not-allowed">
                        <p class="text-xs text-slate-400">L'email ne peut pas être modifié</p>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="font-semibold text-white mb-4">Notifications</h3>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-white font-medium block">Notifications Email</label>
                            <p class="text-sm text-slate-400">Recevoir des alertes par email</p>
                        </div>
                        <button @click="preferences.email_notifications = !preferences.email_notifications"
                            class="w-11 h-6 rounded-full transition-colors relative"
                            :class="preferences.email_notifications ? 'bg-indigo-500' : 'bg-slate-700'">
                            <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"
                                :class="preferences.email_notifications ? 'translate-x-5' : 'translate-x-0'"></span>
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <div>
                            <label class="text-white font-medium block">Rapports Hebdomadaires</label>
                            <p class="text-sm text-slate-400">Résumé de votre portefeuille</p>
                        </div>
                        <button @click="preferences.weekly_reports = !preferences.weekly_reports"
                            class="w-11 h-6 rounded-full transition-colors relative"
                            :class="preferences.weekly_reports ? 'bg-indigo-500' : 'bg-slate-700'">
                            <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"
                                :class="preferences.weekly_reports ? 'translate-x-5' : 'translate-x-0'"></span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Display Preferences -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="font-semibold text-white mb-4">Préférences d'Affichage</h3>
                <div class="space-y-4">
                    <div class="space-y-2">
                        <label class="text-white text-sm font-medium">Devise par Défaut</label>
                        <select x-model="preferences.default_currency"
                            class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="CAD">CAD ($)</option>
                        </select>
                    </div>

                    <div class="space-y-2">
                        <label class="text-white text-sm font-medium">Langue</label>
                        <select x-model="preferences.language"
                            class="w-full bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                            <option value="fr">Français</option>
                            <option value="en">English</option>
                            <option value="es">Español</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- About -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="font-semibold text-white mb-4">À propos</h3>
                <div class="space-y-3">
                    <div class="p-3 rounded-lg bg-slate-800/50">
                        <div class="font-medium text-white">Version</div>
                        <div class="text-sm text-slate-400">Portfolio DSBA v3.0.0</div>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-800/50">
                        <div class="font-medium text-white">Rôle</div>
                        <div class="text-sm text-slate-400" x-text="preferences.role"></div>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-800/50">
                        <div class="font-medium text-white">Membre depuis</div>
                        <div class="text-sm text-slate-400" x-text="formatDate(preferences.created_date)"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="mt-8 mr-4 flex justify-end">
            <button @click="savePreferences" :disabled="isSaving"
                class="bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white px-8 py-2 rounded-lg font-medium transition-all shadow-lg flex items-center gap-2 disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                    <polyline points="17 21 17 13 7 13 7 21" />
                    <polyline points="7 3 7 8 15 8" />
                </svg>
                <span x-text="isSaving ? 'Enregistrement...' : 'Enregistrer'"></span>
            </button>
        </div>
    </div>
</div>

<script type="application/json" id="preferences-data">
    {{ preferences | tojson | safe }}
</script>
<script>
    function settingsApp() {
        return {
            isSaving: false,
            saveMessage: '',
            preferences: (() => {
                const script = document.getElementById('preferences-data');
                return script ? JSON.parse(script.textContent) : {};
            })(),

            async savePreferences() {
                this.isSaving = true;
                try {
                    // Reuse the same /api/profile endpoint as it maps to the same UserProfile object
                    const response = await fetch('/api/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.preferences)
                    });

                    if (response.ok) {
                        this.saveMessage = "Paramètres enregistrés avec succès !";
                    } else {
                        this.saveMessage = "Erreur lors de l'enregistrement.";
                    }
                } catch (e) {
                    console.error(e);
                    this.saveMessage = "Erreur réseau.";
                } finally {
                    this.isSaving = false;
                    setTimeout(() => this.saveMessage = '', 3000);
                }
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleDateString('fr-FR');
            }
        }
    }
</script>
{% endblock %}