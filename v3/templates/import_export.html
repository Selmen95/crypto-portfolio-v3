{% extends "base.html" %}

{% block header %}Import & Export{% endblock %}

{% block content %}
<div x-data="importExportApp()" class="min-h-screen">
    <div class="max-w-5xl mx-auto">
        <div class="mb-8">
            <h1
                class="text-4xl font-bold text-white mb-2 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 text-indigo-400" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="17 1 21 5 17 9" />
                    <path d="M3 11V9a4 4 0 0 1 4-4h14" />
                    <polyline points="7 23 3 19 7 15" />
                    <path d="M21 13v2a4 4 0 0 1-4 4H3" />
                </svg>
                Import & Export
            </h1>
            <p class="text-slate-400 text-lg">
                Gérez vos données facilement
            </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Import Section -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Importer des données</h3>
                        <p class="text-sm text-slate-400">Format CSV supporté</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <div
                        class="border-2 border-dashed border-slate-700 rounded-lg p-8 text-center hover:border-indigo-500 transition-colors cursor-pointer relative">
                        <input type="file" @change="handleFileSelect"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".csv">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-slate-500 mx-auto mb-3"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="12" y1="18" x2="12" y2="12" />
                            <line x1="9" y1="15" x2="15" y2="15" />
                        </svg>
                        <p class="text-slate-300 font-medium">Glissez votre fichier ici ou cliquez</p>
                        <p class="text-slate-500 text-xs mt-1">Symbol, Quantity, Price, Type</p>
                        <template x-if="selectedFile">
                            <div class="mt-4 p-2 bg-indigo-500/20 rounded text-indigo-300 text-sm font-medium"
                                x-text="selectedFile.name"></div>
                        </template>
                    </div>

                    <button @click="uploadFile" :disabled="!selectedFile || importing"
                        class="w-full py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                        <template x-if="importing">
                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </template>
                        <span x-text="importing ? 'Importation...' : 'Importer CSV'"></span>
                    </button>

                    <a href="/download_template"
                        class="block text-center text-xs text-indigo-400 hover:text-indigo-300 underline">Télécharger un
                        modèle CSV</a>
                </div>
            </div>

            <!-- Export Section -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-lg bg-pink-500/20 flex items-center justify-center text-pink-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">Exporter le rapport</h3>
                        <p class="text-sm text-slate-400">Format PDF détaillé</p>
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="p-4 rounded-lg bg-slate-800/50 space-y-3">
                        <h4 class="text-sm font-medium text-slate-300">Aperçu du rapport</h4>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400">Valeur Totale</span>
                            <span class="text-white font-mono" x-text="formatCurrency(stats.totalValue)"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400">Investi</span>
                            <span class="text-white font-mono" x-text="formatCurrency(stats.totalInvested)"></span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-400">P/L Latent</span>
                            <span :class="stats.profitLoss >= 0 ? 'text-green-400' : 'text-red-400'" class="font-mono"
                                x-text="formatCurrency(stats.profitLoss)"></span>
                        </div>
                    </div>

                    <button @click="generatePDF"
                        class="w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-lg font-medium hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                        </svg>
                        Exporter en PDF
                    </button>

                    <button @click="window.location.href='/export_csv'"
                        class="w-full py-3 border border-slate-700 text-slate-300 rounded-lg font-medium hover:bg-slate-800 transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                            <polyline points="7 10 12 15 17 10" />
                            <line x1="12" y1="15" x2="12" y2="3" />
                        </svg>
                        Exporter en CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<script type="application/json" id="assets-data">
    {{ assets | tojson | safe }}
</script>
<script>
    function importExportApp() {
        return {
            selectedFile: null,
            importing: false,
            stats: {
                totalValue: Number("{{ total_val }}") || 0,
                totalInvested: Number("{{ total_invested }}") || 0,
                profitLoss: Number("{{ total_pl }}") || 0,
                profitLossPercentage: Number("{{ total_pl_percent }}") || 0
            },
            assets: (() => {
                const script = document.getElementById('assets-data');
                return script ? JSON.parse(script.textContent) : [];
            })(),

            handleFileSelect(event) {
                this.selectedFile = event.target.files[0];
            },

            async uploadFile() {
                if (!this.selectedFile) return;

                this.importing = true;
                const formData = new FormData();
                formData.append('file', this.selectedFile);

                try {
                    const response = await fetch('/import_csv', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        alert('Import réussi !');
                        window.location.reload();
                    } else {
                        alert("Erreur lors de l'import");
                    }
                } catch (e) {
                    console.error(e);
                    alert("Erreur réseau");
                } finally {
                    this.importing = false;
                    this.selectedFile = null;
                }
            },

            generatePDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(22);
                doc.setTextColor(79, 70, 229); // Indigo
                doc.text("Rapport de Portefeuille", 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Généré le ${new Date().toLocaleDateString('fr-FR')}`, 14, 28);

                // Stats Grid
                doc.setFillColor(243, 244, 246);
                doc.roundedRect(14, 35, 180, 25, 3, 3, 'F');

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("Valeur Totale", 20, 42);
                doc.text("Investissement", 80, 42);
                doc.text("P/L Global", 140, 42);

                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.text(this.formatCurrency(this.stats.totalValue), 20, 52);
                doc.text(this.formatCurrency(this.stats.totalInvested), 80, 52);

                const plColor = this.stats.profitLoss >= 0 ? [34, 197, 94] : [239, 68, 68];
                doc.setTextColor(plColor[0], plColor[1], plColor[2]);
                doc.text(this.formatCurrency(this.stats.profitLoss), 140, 52);

                // Assets Table
                const tableData = this.assets.map(a => [
                    a.symbol,
                    a.name || a.symbol,
                    a.quantity,
                    this.formatCurrency(a.buy_price),
                    this.formatCurrency(a.current_price),
                    this.formatCurrency(a.value),
                    (a.pl_percent).toFixed(2) + '%'
                ]);

                doc.autoTable({
                    startY: 70,
                    head: [['Symbole', 'Nom', 'Qté', 'Prix Achat', 'Prix Actuel', 'Valeur', 'Perf %']],
                    body: tableData,
                    theme: 'grid',
                    headStyles: { fillColor: [79, 70, 229] },
                    alternateRowStyles: { fillColor: [249, 250, 251] }
                });

                doc.save("rapport-portefeuille.pdf");
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'USD' }).format(value);
            }
        }
    }
</script>
{% endblock %}