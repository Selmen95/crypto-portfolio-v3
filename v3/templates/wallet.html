{% extends "base.html" %}

{% block header %}Portefeuille{% endblock %}

{% block content %}
<div x-data="walletApp()" class="min-h-screen">
    <div class="max-w-7xl mx-auto">
        <div class="mb-8 pl-4">
            <h1
                class="text-4xl font-bold text-white mb-2 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                Portefeuille
            </h1>
            <p class="text-slate-400 text-lg">
                Vue d'ensemble de vos investissements
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="grid lg:grid-cols-3 gap-6 mb-6 px-4">
            <!-- Total Value -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <div class="flex flex-row items-center justify-between pb-2 mb-2">
                    <h3 class="text-sm font-medium text-slate-300">Valeur Totale</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-400" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2" />
                        <line x1="1" y1="10" x2="23" y2="10" />
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" x-text="formatCurrency(stats.totalValue)"></div>
            </div>

            <!-- Capital Invested -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <div class="flex flex-row items-center justify-between pb-2 mb-2">
                    <h3 class="text-sm font-medium text-slate-300">Capital Investi</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-emerald-400" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                        <polyline points="17 6 23 6 23 12" />
                    </svg>
                </div>
                <div class="text-3xl font-bold text-white" x-text="formatCurrency(stats.totalInvested)"></div>
            </div>

            <!-- Profit/Loss -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <div class="flex flex-row items-center justify-between pb-2 mb-2">
                    <h3 class="text-sm font-medium text-slate-300">Profit/Perte</h3>
                    <template x-if="stats.profitLoss >= 0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-400" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="7" y1="17" x2="17" y2="7" />
                            <polyline points="7 7 17 7 17 17" />
                        </svg>
                    </template>
                    <template x-if="stats.profitLoss < 0">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-400" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round">
                            <line x1="7" y1="7" x2="17" y2="17" />
                            <polyline points="17 7 17 17 7 17" />
                        </svg>
                    </template>
                </div>
                <div class="text-3xl font-bold" :class="stats.profitLoss >= 0 ? 'text-green-400' : 'text-red-400'"
                    x-text="(stats.profitLoss >= 0 ? '+' : '') + formatCurrency(stats.profitLoss)">
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 px-4">
            <!-- Assets List -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="text-xl font-semibold text-white mb-4">Mes Actifs</h3>
                <div class="space-y-3">
                    <template x-for="asset in assets.slice(0, 5)" :key="asset.id">
                        <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                            <div>
                                <div class="font-medium text-white" x-text="asset.name || asset.symbol"></div>
                                <div class="text-sm text-slate-400" x-text="asset.quantity + ' unités'"></div>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-white"
                                    x-text="formatCurrency(asset.quantity * (asset.current_price || asset.buy_price))">
                                </div>
                            </div>
                        </div>
                    </template>
                    <template x-if="assets.length === 0">
                        <div class="text-center py-8 text-slate-400">
                            Aucun actif dans votre portefeuille
                        </div>
                    </template>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                <h3 class="text-xl font-semibold text-white mb-4">Transactions Récentes</h3>
                <div class="space-y-3">
                    <template x-for="tx in transactions.slice(0, 10)" :key="tx.id">
                        <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg">
                            <div>
                                <div class="font-medium text-white" x-text="tx.asset_name || tx.symbol"></div>
                                <div class="text-sm text-slate-400">
                                    <span
                                        x-text="(tx.transaction_type === 'buy' ? 'Achat' : 'Vente') + ' - ' + tx.quantity + ' unités'"></span>
                                </div>
                            </div>
                            <div class="font-semibold"
                                :class="tx.transaction_type === 'buy' ? 'text-red-400' : 'text-green-400'"
                                x-text="(tx.transaction_type === 'buy' ? '-' : '+') + formatCurrency(tx.total_amount || (tx.quantity * tx.price))">
                            </div>
                        </div>
                    </template>
                    <template x-if="transactions.length === 0">
                        <div class="text-center py-8 text-slate-400">
                            Aucune transaction
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

<script id="assets-data" type="application/json">
    {{ assets | tojson | safe }}
</script>
<script id="transactions-data" type="application/json">
    {{ transactions | tojson | safe }}
</script>

<script>
    function walletApp() {
        const assetsData = JSON.parse(document.getElementById('assets-data').textContent);
        const transactionsData = JSON.parse(document.getElementById('transactions-data').textContent);

        return {
            assets: assetsData,
            transactions: transactionsData,

            get stats() {
                let totalValue = 0;
                let totalInvested = 0;

                this.assets.forEach(asset => {
                    // If current_price is explicitly passed from backend (via live fetch), use it.
                    // Otherwise fallback to purchase_price (buy_price)
                    const price = asset.current_price !== undefined ? asset.current_price : asset.buy_price;

                    const currentValue = asset.quantity * price;
                    const investedValue = asset.quantity * asset.buy_price;

                    totalValue += currentValue;
                    totalInvested += investedValue;
                });

                return {
                    totalValue,
                    totalInvested,
                    profitLoss: totalValue - totalInvested
                };
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(value);
            }
        }
    }
</script>
{% endblock %}