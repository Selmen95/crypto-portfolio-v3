{% extends "base.html" %}

{% block header %}Historique des Transactions{% endblock %}

{% block content %}
<div x-data="transactionsApp()" class="min-h-screen">
    <div class="max-w-7xl mx-auto">
        <div class="mb-8 pl-4">
            <h1
                class="text-4xl font-bold text-white mb-2 bg-gradient-to-r from-indigo-400 via-purple-400 to-pink-400 bg-clip-text text-transparent flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-400" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="17 1 21 5 17 9" />
                    <path d="M3 11V9a4 4 0 0 1 4-4h14" />
                    <polyline points="7 23 3 19 7 15" />
                    <path d="M21 13v2a4 4 0 0 1-4 4H3" />
                </svg>
                Historique des Transactions
            </h1>
            <p class="text-slate-400 text-lg">
                Toutes vos opérations d'achat et de vente
            </p>
        </div>

        <!-- Filters -->
        <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm mb-6 rounded-xl mx-4">
            <div class="p-6 border-b border-slate-800">
                <h3 class="text-white font-semibold flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" />
                    </svg>
                    Filtres
                </h3>
            </div>
            <div class="p-6">
                <div class="grid md:grid-cols-4 gap-4">
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8" />
                            <line x1="21" y1="21" x2="16.65" y2="16.65" />
                        </svg>
                        <input type="text" placeholder="Rechercher..." x-model="searchTerm"
                            class="w-full pl-10 bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                    </div>

                    <select x-model="typeFilter"
                        class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="all">Tous types</option>
                        <option value="buy">Achats</option>
                        <option value="sell">Ventes</option>
                    </select>

                    <select x-model="statusFilter"
                        class="bg-slate-800 border border-slate-600 rounded px-3 py-2 text-white focus:outline-none focus:border-indigo-500">
                        <option value="all">Tous actifs</option>
                        <option value="stock">Actions</option>
                        <option value="crypto">Crypto</option>
                        <option value="forex">Forex</option>
                        <option value="commodity">Matières Premières</option>
                        <option value="other">Autre</option>
                    </select>

                    <div class="text-right">
                        <div class="text-xs text-slate-400 uppercase tracking-wider font-bold">Total</div>
                        <div class="text-lg font-bold text-white px-2" x-text="filteredTransactions.length"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl overflow-hidden mx-4">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="border-b border-slate-800 bg-slate-900/50">
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Date
                            </th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Actif
                            </th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Type
                            </th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">
                                Quantité</th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Prix
                            </th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Total
                            </th>
                            <th class="text-left p-4 text-xs font-medium text-slate-400 uppercase tracking-wider">Frais
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800">
                        <template x-for="tx in filteredTransactions" :key="tx.id">
                            <tr class="hover:bg-slate-800/30 transition-colors">
                                <td class="p-4 text-slate-300">
                                    <div x-text="formatDate(tx.transaction_date)"></div>
                                    <div class="text-xs text-slate-500" x-text="formatTime(tx.transaction_date)"></div>
                                </td>
                                <td class="p-4">
                                    <div class="text-white font-medium" x-text="tx.asset_name"></div>
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border mt-1"
                                        :class="getAssetTypeColor(tx.asset_type)" x-text="tx.asset_type">
                                    </span>
                                </td>
                                <td class="p-4">
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium border"
                                        :class="getTypeColor(tx.transaction_type)"
                                        x-text="tx.transaction_type === 'buy' ? 'ACHAT' : 'VENTE'">
                                    </span>
                                </td>
                                <td class="p-4 text-white font-medium" x-text="tx.quantity"></td>
                                <td class="p-4 text-slate-300" x-text="formatCurrency(tx.price)"></td>
                                <td class="p-4">
                                    <div class="font-semibold"
                                        :class="tx.transaction_type === 'buy' ? 'text-red-400' : 'text-green-400'"
                                        x-text="(tx.transaction_type === 'buy' ? '-' : '+') + formatCurrency(tx.total_amount)">
                                    </div>
                                </td>
                                <td class="p-4 text-slate-400" x-text="formatCurrency(tx.fees)"></td>
                            </tr>
                        </template>
                        <tr x-show="filteredTransactions.length === 0">
                            <td colspan="7" class="p-12 text-center text-slate-400">
                                <div class="flex flex-col items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 opacity-50"
                                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                        stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                    <span>Aucune transaction trouvée</span>
                                    <span class="text-sm">Essayez d'ajuster vos filtres</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script id="transactions-data" type="application/json">
    {{ transactions | tojson }}
</script>

<script>
    function transactionsApp() {
        const transactionsData = JSON.parse(document.getElementById('transactions-data').textContent);
        return {
            transactions: transactionsData,
            searchTerm: '',
            typeFilter: 'all',
            statusFilter: 'all', // Used for Asset Type

            get filteredTransactions() {
                return this.transactions.filter(tx => {
                    const matchesSearch = !this.searchTerm ||
                        (tx.asset_name && tx.asset_name.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
                        (tx.asset_type && tx.asset_type.toLowerCase().includes(this.searchTerm.toLowerCase())) ||
                        (tx.symbol && tx.symbol.toLowerCase().includes(this.searchTerm.toLowerCase()));

                    const matchesType = this.typeFilter === 'all' || tx.transaction_type === this.typeFilter;
                    const matchesAsset = this.statusFilter === 'all' || tx.asset_type === this.statusFilter;

                    return matchesSearch && matchesType && matchesAsset;
                });
            },

            getTypeColor(type) {
                return type === 'buy'
                    ? 'bg-green-500/20 text-green-400 border-green-500/30'
                    : 'bg-red-500/20 text-red-400 border-red-500/30';
            },

            getAssetTypeColor(assetType) {
                const colors = {
                    stock: 'bg-indigo-500/20 text-indigo-400 border-indigo-500/30',
                    crypto: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
                    real_estate: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
                    commodity: 'bg-red-500/20 text-red-400 border-red-500/30',
                    bond: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
                    etf: 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30',
                    other: 'bg-slate-500/20 text-slate-400 border-slate-500/30'
                };
                return colors[assetType] || colors['other'];
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(value);
            },

            formatDate(dateStr) {
                if (!dateStr) return '-';
                return new Date(dateStr).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });
            },

            formatTime(dateStr) {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
        }
    }
</script>
{% endblock %}