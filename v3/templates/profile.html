{% extends "base.html" %}

{% block header %}Profil & Paramètres{% endblock %}

{% block content %}
<div x-data="profileApp()" class="min-h-screen">
    <div class="max-w-6xl mx-auto">
        <div class="mb-8 pl-4">
            <h1 class="text-3xl font-bold text-white mb-2 flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                </svg>
                Profil & Paramètres
            </h1>
            <p class="text-slate-400">
                Gérez votre compte, vos préférences et visualisez vos succès
            </p>
        </div>

        <!-- Success/Error Message -->
        <div x-show="saveMessage" x-transition
            class="mb-6 mx-4 p-4 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
            <span x-text="saveMessage"></span>
        </div>

        <div class="grid lg:grid-cols-3 gap-6 px-4">
            <!-- Profile Card & Stats -->
            <div class="lg:col-span-1 space-y-6">
                <!-- User Card -->
                <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="relative group cursor-pointer" @click="$refs.fileInput.click()">
                            <template x-if="user.profile_picture_url">
                                <img :src="user.profile_picture_url" alt="Profile"
                                    class="w-20 h-20 rounded-full object-cover border-2 border-slate-700 group-hover:border-indigo-500 transition-colors">
                            </template>
                            <template x-if="!user.profile_picture_url">
                                <div
                                    class="w-20 h-20 bg-gradient-to-r from-green-400 to-emerald-500 rounded-full flex items-center justify-center border-2 border-slate-700 group-hover:border-indigo-500 transition-colors">
                                    <span class="text-white font-bold text-2xl"
                                        x-text="user.full_name.charAt(0) || 'U'"></span>
                                </div>
                            </template>
                            <div
                                class="absolute bottom-0 right-0 w-7 h-7 bg-slate-700 rounded-full flex items-center justify-center group-hover:bg-indigo-500 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                    <circle cx="12" cy="13" r="4" />
                                </svg>
                            </div>
                            <input type="file" x-ref="fileInput" @change="handleImageUpload" class="hidden"
                                accept="image/*">
                        </div>
                        <div class="flex-1">
                            <input type="text" x-model="user.full_name"
                                class="bg-slate-800/50 border border-slate-700 rounded px-2 py-1 text-white font-bold text-xl w-full focus:ring-2 focus:ring-indigo-500 focus:outline-none" />
                            <p class="text-slate-400 text-sm mt-1" x-text="user.email"></p>
                        </div>
                    </div>
                    <textarea x-model="user.bio" placeholder="Votre biographie..."
                        class="w-full h-24 bg-slate-800/50 border border-slate-700 rounded-lg p-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"></textarea>
                </div>

                <!-- Stats Card -->
                <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                    <h3 class="font-semibold text-white mb-4">Statistiques Trading</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-green-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <line x1="12" y1="1" x2="12" y2="23" />
                                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
                                    </svg>
                                </div>
                                <span class="text-slate-300">Profit Total</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-white" x-text="formatCurrency(stats.total_profit)"></div>
                                <div class="text-xs text-green-400">+23.4%</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-blue-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" />
                                        <polyline points="17 6 23 6 23 12" />
                                    </svg>
                                </div>
                                <span class="text-slate-300">Win Rate</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-white">73.2%</div>
                                <div class="text-xs text-green-400">+5.1%</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 bg-slate-800 rounded-lg flex items-center justify-center text-purple-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <circle cx="12" cy="8" r="7" />
                                        <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
                                    </svg>
                                </div>
                                <span class="text-slate-300">Trades Total</span>
                            </div>
                            <div class="text-right">
                                <div class="font-semibold text-white" x-text="stats.total_trades"></div>
                                <div class="text-xs text-green-400">+12</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings & Achievements -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Notifications -->
                <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" />
                            <path d="M13.73 21a2 2 0 0 1-3.46 0" />
                        </svg>
                        Préférences de Notification
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-white flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                        <polyline points="22,6 12,13 2,6" />
                                    </svg>
                                    Notifications Email
                                </label>
                                <p class="text-sm text-slate-400 ml-6">Recevoir des alertes pour les trades exécutés</p>
                            </div>
                            <button
                                @click="user.notifications_config.email_trades = !user.notifications_config.email_trades"
                                class="w-11 h-6 rounded-full transition-colors relative"
                                :class="user.notifications_config.email_trades ? 'bg-green-500' : 'bg-slate-700'">
                                <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"
                                    :class="user.notifications_config.email_trades ? 'translate-x-5' : 'translate-x-0'"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-white flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                        <polyline points="22,6 12,13 2,6" />
                                    </svg>
                                    Alertes Profit
                                </label>
                                <p class="text-sm text-slate-400 ml-6">Notifications pour les objectifs de profit</p>
                            </div>
                            <button
                                @click="user.notifications_config.email_profits = !user.notifications_config.email_profits"
                                class="w-11 h-6 rounded-full transition-colors relative"
                                :class="user.notifications_config.email_profits ? 'bg-green-500' : 'bg-slate-700'">
                                <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"
                                    :class="user.notifications_config.email_profits ? 'translate-x-5' : 'translate-x-0'"></span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label class="text-white flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path
                                            d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                                        <polyline points="22,6 12,13 2,6" />
                                    </svg>
                                    Activité Communauté
                                </label>
                                <p class="text-sm text-slate-400 ml-6">Mentions, abonnés et réponses aux posts</p>
                            </div>
                            <button
                                @click="user.notifications_config.email_community = !user.notifications_config.email_community"
                                class="w-11 h-6 rounded-full transition-colors relative"
                                :class="user.notifications_config.email_community ? 'bg-green-500' : 'bg-slate-700'">
                                <span class="absolute top-1 left-1 bg-white w-4 h-4 rounded-full transition-transform"
                                    :class="user.notifications_config.email_community ? 'translate-x-5' : 'translate-x-0'"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- KYC -->
                <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                            <polyline points="14 2 14 8 20 8" />
                            <line x1="16" y1="13" x2="8" y2="13" />
                            <line x1="16" y1="17" x2="8" y2="17" />
                            <polyline points="10 9 9 9 8 9" />
                        </svg>
                        Vérification d'Identité (KYC)
                    </h3>
                    <div class="space-y-4">
                        <div
                            class="p-4 rounded-lg bg-yellow-500/20 border border-yellow-500/30 text-yellow-500 text-sm">
                            Votre compte n'est pas vérifié. Veuillez compléter le KYC pour débloquer des limites de
                            retrait plus élevées.
                        </div>
                        <p class="text-sm text-slate-400">
                            Le processus KYC est une mesure de sécurité obligatoire. Cette fonctionnalité nécessite une
                            intégration tierce et est actuellement désactivée.
                        </p>
                        <button
                            class="w-full py-2 border border-slate-600 text-slate-300 rounded hover:bg-slate-700 transition-colors opacity-50 cursor-not-allowed">
                            Démarrer la Vérification
                        </button>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="bg-slate-900/50 border border-slate-800 backdrop-blur-sm rounded-xl p-6">
                    <h3 class="font-semibold text-white mb-4 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="8" r="7" />
                            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
                        </svg>
                        Succès
                    </h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <template x-for=" achievement in achievements">
                            <div class="p-4 rounded-lg border-2 transition-all"
                                :class="achievement.earned ? 'bg-green-500/10 border-green-500/30' : 'bg-slate-800/30 border-slate-700'">
                                <div class="flex items-center gap-3 mb-2">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                                        :class="achievement.earned ? 'bg-green-500' : 'bg-slate-600'">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="8" r="7" />
                                            <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88" />
                                        </svg>
                                    </div>
                                    <h3 class="font-semibold"
                                        :class="achievement.earned ? 'text-green-400' : 'text-slate-400'"
                                        x-text="achievement.title"></h3>
                                </div>
                                <p class="text-sm text-slate-400 mb-2" x-text="achievement.description"></p>
                                <p class="text-xs" :class="achievement.earned ? 'text-green-400' : 'text-slate-500'"
                                    x-text="achievement.earned ? 'Obtenu ' + achievement.date : 'Progression: ' + achievement.progress">
                                </p>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button @click="saveProfile" :disabled="isSaving"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium shadow-lg shadow-green-500/20 transition-all flex items-center gap-2 disabled:opacity-50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
                            <polyline points="17 21 17 13 7 13 7 21" />
                            <polyline points="7 3 7 8 15 8" />
                        </svg>
                        <span x-text="isSaving ? 'Enregistrement...' : 'Enregistrer les modifications'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="user-profile-data">
    {{ user_profile | tojson | safe }}
</script>
<script>
    function profileApp() {
        return {
            isSaving: false,
            saveMessage: '',
            user: (() => {
                const script = document.getElementById('user-profile-data');
                return script ? JSON.parse(script.textContent) : {};
            })(),
            stats: {
                total_profit: 12847, // Mocked for now or passed from backend
                total_trades: 156
            },
            achievements: [
                { title: "Premier Trade", description: "Complété votre premier trade réussi", earned: true, date: "il y a 2 semaines" },
                { title: "Série Gagnante", description: "5 trades profitables d'affilée", earned: true, date: "il y a 1 semaine" },
                { title: "Maître du Risque", description: "Maintenir <2% drawdown pour 30 jours", earned: false, progress: "18/30 jours" },
                { title: "Aide de Communauté", description: "Aider 10 traders dans la commu", earned: false, progress: "3/10 aidés" }
            ],

            handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Simulating upload by reading as data URL for preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.user.profile_picture_url = e.target.result;
                };
                reader.readAsDataURL(file);
            },

            async saveProfile() {
                this.isSaving = true;
                try {
                    const response = await fetch('/api/profile', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.user)
                    });
                    if (response.ok) {
                        this.saveMessage = "Profil enregistré avec succès !";
                    } else {
                        this.saveMessage = "Erreur lors de l'enregistrement.";
                    }
                } catch (e) {
                    this.saveMessage = "Erreur réseau.";
                } finally {
                    this.isSaving = false;
                    setTimeout(() => this.saveMessage = '', 3000);
                }
            },

            formatCurrency(value) {
                return new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(value);
            }
        }
    }
</script>
{% endblock %}